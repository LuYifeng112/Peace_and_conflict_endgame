# military loyalty 


#init_loyalty = {
#	clear_array = loyalty_array_val
#	clear_array = loyalty_array_calc
#	clear_array = loyalty_array
#}

startup_loyalty = {
	sort_loyalty = yes 
}

recalculate_loyalty = {
	sort_loyalty = yes
}

sort_loyalty = {
	resize_temp_array = { 
		array = loyalty_array_val_temp #values
		size = loyalty_array_val^num
	}
	resize_temp_array = { 
		array = loyalty_array_temp #tags
		size = loyalty_array_val^num
	}
	for_loop_effect = {
		end = loyalty_array_val^num
		value = v
		find_highest_in_array = {
			array = loyalty_array_val 
			value = max
			index = max_index
		}
		set_temp_variable = { loyalty_array_val_temp^v = max } 
		set_temp_variable = { loyalty_array_temp^v = loyalty_array^max_index } 
		set_variable = { loyalty_array_val^max_index = -1 } 
	}
	clear_array = loyalty_array_val
	clear_array = loyalty_array_calc
	clear_array = loyalty_array
	set_variable = { loyalty_total = 0 }
	#restores destroyed arrays in the above process
	for_each_loop = {
		array = loyalty_array_val_temp
		add_to_array = { loyalty_array_val = v  }
		add_to_array = { loyalty_array_calc = v }
		add_to_variable = { loyalty_total = v }
	}
	for_each_loop = {
		array = loyalty_array_temp
		add_to_array = { loyalty_array = v  }
	}
	clear_temp_array = loyalty_array_val_temp
	clear_temp_array = loyalty_array_temp
	set_variable = { military_influence_amount_calc = military_influence_amount }
	add_to_variable = { loyalty_total = military_influence_amount_calc }
	
	for_each_loop = {
		array = loyalty_array_calc
		round_variable = loyalty_array_calc^i
		divide_variable = { loyalty_array_calc^i = loyalty_total }
		clamp_variable = { var = loyalty_array_calc^i min = 0 max = 1 }
		clamp_variable = { var = loyalty_array_val^i min = 0 max = loyalty_total }
	}
	
	round_variable = military_influence_amount_calc
	divide_variable = { military_influence_amount_calc = loyalty_total }
	clamp_variable = { var = military_influence_amount_calc min = 0 max = 1 }
	clamp_variable = { var = military_influence_amount min = 0 max = loyalty_total }
}

#scriptty time the fun stuff

#increase number of divisions (down) loyalty, money+CP (up) loyalty, lower stbaility (down) loyalty
#exception is ideological fanatcism like fascism & communism

loyalty_is_just_being_nice = {
	set_variable = { military_power = num_divisions }
	add_to_variable = {military_power = stability }
	add_to_variable = {military_power = party_popularity@ruling_party }
	add_to_varaible = {militarism = military_power}
}

### Actions to deal with Loyalty ###

#What a democracy should be doing
pay_up_now = {
			
	PREV = { add_command_power = -120 }
	
	set_temp_variable = { loyalty_gain = PREV.loyalty_multiplier }
	multiply_temp_variable = { loyalty_gain = 10 } #base gain
	for_loop_effect = {
		end = loyalty_array^num
		value = v
		if = {
			limit = {
				check_variable = { loyalty_array^v = PREV }
			}
			add_to_variable = { loyalty_array_val^v = loyalty_gain }
			set_country_flag = has_bucks_keeps_head
		}
	}
	if = {
		limit = { NOT = { has_country_flag = has_bucks_keeps_head } }
			add_to_array = { loyalty_array = PREV.id }
			add_to_array = { loyalty_array_val = influence_gain }
	}
	clr_country_flag = has_bucks_keeps_head
	recalculate_loyalty = yes
}

#effective not gonna lie
gulag_time = {
	
	PREV = { add_political_power = 50}
	PREV = { add_stability = -5 }
	PREV = { add_manpower = -5000 }
	#PREV = { defense_level = -10 } should check this one
	PREV = { add_threat = 2 }
	PREV = { army_experience = -50 }
	PREV = { add_command_power = 100 }

	####################how to get the loyalty up?
	set_temp_variable = { loyalty_gain = PREV.loyalty_multiplier }
	multiply_temp_variable = { loyalty_gain = 15 } #base gain
	for_loop_effect = {
		end = loyalty_array^num
		value = v
		if = {
			limit = {
				check_variable = { loyalty_array^v = PREV }
			}
			add_to_variable = { loyalty_array_val^v = loyalty_gain }
			set_country_flag = has_bucks_keeps_head
		}
	}
	if = {
		limit = { NOT = { has_country_flag = has_bucks_keeps_head } }
			add_to_array = { loyalty_array = PREV.id }
			add_to_array = { loyalty_array_val = influence_gain }
	}
	clr_country_flag = has_bucks_keeps_head
	recalculate_loyalty = yes 
}


#Military grows and they need a deal mwahahahaa
